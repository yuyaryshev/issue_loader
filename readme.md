# Назначение и верхнеуровневая архитектура
Данная программа предназначена для репликации данных о инцидентах и TimeSheet из Jira в Oracle. Она написана на Typescript и для работы требует Node.js

Она подключается к Jira по REST API, затем к Oracle - через Oracle Client и сохраняет туда загруженные данные.

Поддерживается инкрементальная загрузка в которой загружаются только измененные инциденты.

---

# Руководство администратора
## Основные правила использования
- Никогда не редактируйте и не изменяйте таблиц `dont_touch__*` - см. [Зачем нужны dont_touch таблицы](#Зачем-нужны-dont_touch-таблицы)  

## Установка
- Для установки требуются права администратора
- Установите **Node.js** - с внутреннего портала Альфа-банка или из интернета
- Настройте локальный репозиторий пакетов Альфа-банка для **Node.js**:

        npm config set registry http://mvn/artifactory/api/npm/npmjs

- В папке программы запустите **`npm i`** для автоматического развертывания папки ***node_modules***
- Для постоянной работы установить глобально и рекомендуется использовать пакет **pm2**, он настраивается так:
    - Выполните `npm i pm2 -g`

    - Для Windows дополнительно нужно сделать следующее:
        - Откройте переменные среды (**`Win+Pause-break / Дополнительные параметры системы/ Переменные среды`**)
        - Удостоверьтесь в **`PATH`** есть **`C:\Users\::Имя_Пользователя::\AppData\Roaming\npm`**
        - Добавьте **`PM2_HOME`** равной **`c:\etc\.pm2`**

                mkdir c:\etc
                mkdir c:\etc\.pm2
                pm2-service-install -n PM2

    - И для Windows и для Linux требуется добавить issue_loader в список мониторинга pm2

            pm2 start.js --name issue_loader --log issue_loader.log
            pm2 save
- Все настройки необходимо ввести в файле **`settings.json`**. Пример настроек - см в **`settings_example.json`**

## Запуск, остановка, перезапуск
- Если используется **pm2** (см), то запуск осуществляется автоматически при старте системы
    - Запуск **`pm2 start issue_loader`**
    - Остановка **`pm2 stop issue_loader`**
    - Перезапуск **`pm2 restart issue_loader`**
    - Более детально - см документацию pm2 на официальном сайте
- Для запуска без pm2 выполните в коммандной строке **`npm start`**

## Мониторинг и управление
В случае если в файле **`settings.json`** задан **`monitorEndpointPort`**, то консоль мониторинга и управления доступна через браузер по данному порту. Данные в консоли обновляются автоматически. Если данные мониторинга требуются для машинной обработки - они доступны в формате JSON по адресу **`/api/runStatus`**. Счетчики загрузок расчитываются с момента запуска сервера и в кратные интервалы времени - каждые 10 минут и раз в сутки в 00:00.

# Руководство разработчика
В качестве средства редактирования исходников рекомендуется использовать бесплатный **`Visual Studio Code`** или платный **`WebStorm`**
## Структура исходников
// TODO TBD  Структура исходников
### **`TBD  Структура исходников - JSON api`**

// TODO deploySchema.ts - функции генерации схемы БД
// TODO Migration.ts - позволяет изменять состав загружаемых полей.
    Как использовать:
    - Измените поля
// TODO loadJiraFields.ts - загрузка данных о полях из Jira, - обновление в БД Oracle jira_fields

// TODO loadJiraIssues.ts - загрузка данных о инцидентах из Jira, - обновление в БД Oracle jira_issue и jira_worklog
    В процессе загрузки для трансляций используется информация о полях - из current_jira_issue оттуда берется тип и название поля в таблице current_jira_issue), поэтому
    в начале загрузки


cycle_http_call.ts - тестовый скрипт, в загрузке не используется. Содержит скрипт который циклически дергает заданный http адрес.
deploy_schema.ts

## Зачем нужны dont_touch таблицы
 - Эти таблицы содержат копии метаданных необходимые для корректной загрузки.
- Их удаление или изменение сделают невозможным повторный запуск сервера загрузки.
- Если вам зачем-то потребовались текущие метаданные от загрузки - читать их можно и нужно из таблиц dont_touch__*
- Данные таблицы изменяются при выполнении migrate

# Задачи
- Порядок вызовов
    - run
        - Запись в ISSUE_LOADER_STREAMS
        - Записать в JIRA_ISSUE_JSON
        - Записать в JIRA_ISSUE
    - prepareLoadJiraIssues - создает функции загрузки
    - prepareLoadJiraIssues.worker - записывает данные в oracle


# Процесс обработки изменений Issue Jira
    - Когда поступает новое изменение
        - Записываем в issueCache
        - Сразу трансформируем его и записываем в JIRA_ISSUE
    - При необходимости перезагрузки уже загруженных
        - Без кеша
            - Просто сбрасываем все счетчики и грузим с самого начала
        - По кешу
            - Считаем что в issueCache уже все есть
            - Не используем никакие очереди, вместо это тупо Runtime - ЦИКЛОМ обходим ВСЕ записи в issueCache
                - И тут же пишем в JIRA_ISSUE

# Полезные ссылки

Jira REST API
https://developer.atlassian.com/cloud/jira/platform/rest/v3/

Worklog
https://developer.atlassian.com/cloud/jira/platform/rest/v3/#api-rest-api-3-issue-issueIdOrKey-worklog-get